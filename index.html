<!DOCTYPE html>
<html>
<head>
  <title>Excel Data Viewer - Built by sengly.seang</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-container: #ffffff;
      --text-primary: #2c3e50;
      --text-secondary: #7f8c8d;
      --border-color: #e1e8ed;
      --header-bg: #f2f2f2;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
      --btn-primary: #4CAF50;
      --btn-primary-hover: #45a049;
      --btn-secondary: #2196F3;
      --btn-secondary-hover: #0b7dda;
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-container: #252525;
      --text-primary: #e0e0e0;
      --text-secondary: #a0a0a0;
      --border-color: #404040;
      --header-bg: #333333;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Hide scrollbar but keep functionality */
    * {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }

    *::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }

    /* Force font family globally */
    * {
      font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      transition: all 0.3s ease;
      overflow-x: hidden;
    }

    .header {
      max-width: 1400px;
      margin: 0 auto 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-container);
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .theme-toggle {
      background: var(--btn-secondary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .theme-toggle:hover {
      background: var(--btn-secondary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
      transition: all 0.3s ease;
      display: inline-block;
    }

    .file-input-label:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    #output {
      max-width: 1400px;
      margin: 0 auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: var(--bg-container);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    th, td {
      border: 1px solid var(--border-color);
      padding: 12px 16px;
      text-align: left;
      transition: all 0.2s ease;
    }

    th {
      background: var(--header-bg);
      color: var(--text-primary);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 1px;
    }

    tr:hover td {
      background: var(--bg-secondary);
    }

    td.sender-account { 
      color: #1e90ff;
      font-weight: 500;
    }

    td.receiver-account { 
      color: #32cd32;
      font-weight: 500;
    }

    td.other-column { 
      color: var(--text-secondary);
    }

    .export-btn {
      margin-left: 10px;
      padding: 8px 20px;
      background: linear-gradient(135deg, var(--btn-primary) 0%, #66bb6a 100%);
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .service-container {
      margin-bottom: 40px;
      background: var(--bg-container);
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .service-container:hover {
      box-shadow: var(--shadow-hover);
    }

    .service-container h2 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
      letter-spacing: -0.3px;
    }

    .service-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    label {
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    select {
      padding: 8px 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      outline: none;
    }

    select:hover {
      border-color: var(--btn-secondary);
    }

    select:focus {
      border-color: var(--btn-secondary);
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
      font-size: 16px;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-container);
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow-hover);
      max-width: 500px;
      width: 90%;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }

    .modal-header h3 {
      font-size: 18px;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .modal-body {
      margin: 20px 0;
    }

    .modal-body p {
      color: var(--text-secondary);
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-cancel {
      padding: 8px 20px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-cancel:hover {
      background: var(--border-color);
    }

    .converter-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .converter-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .header-row-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-secondary);
      padding: 10px 15px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
    }

    .header-row-selector label {
      margin: 0;
      font-size: 14px;
    }

    .header-row-selector input {
      width: 60px;
      padding: 5px 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-container);
      color: var(--text-primary);
      font-size: 14px;
      text-align: center;
    }

    .settings-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .settings-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .column-mapping {
      margin-bottom: 15px;
    }

    .column-mapping label {
      display: block;
      margin-bottom: 5px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .column-mapping input {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .column-mapping input:focus {
      outline: none;
      border-color: var(--btn-secondary);
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .modal-content.wide {
      max-width: 600px;
    }

    .footer {
      max-width: 1400px;
      margin: 30px auto 0;
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
    }

    .footer .builder {
      font-weight: 700;
      color: var(--text-primary);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.5px;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
      }

      .service-controls {
        flex-direction: column;
        align-items: flex-start;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px;
      }

      .modal-content {
        width: 95%;
        padding: 20px;
      }

      .header-controls {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Excel Data Viewer</h1>
    <div class="header-controls">
      <div class="file-input-wrapper">
        <input type="file" id="jsonInput" accept=".json">
        <label for="jsonInput" class="file-input-label">Choose User Account JSON</label>
      </div>
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" accept=".xlsx">
        <label for="fileInput" class="file-input-label">Choose Excel File</label>
      </div>
      <div class="header-row-selector">
        <label for="headerRowInput">Header Row:</label>
        <input type="number" id="headerRowInput" value="4" min="1" max="100">
      </div>
      <button class="settings-btn" onclick="openSettingsModal()">Column Settings</button>
      <button class="converter-btn" onclick="openConverterModal()">Convert UserAccount</button>
      <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">●</span>
        <span id="theme-text">Dark Mode</span>
      </button>
    </div>
  </div>
  <div id="output"></div>

  <div class="footer">
    Built with (+_+) by <span class="builder">sengly.seang</span>
  </div>

  <!-- Column Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content wide">
      <div class="modal-header">
        <h3>Column Header Settings</h3>
        <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Configure column header names if your Excel file uses different naming conventions.</p>
        
        <div class="column-mapping">
          <label>NO Column:</label>
          <input type="text" id="col-NO" value="NO" placeholder="Enter column name">
        </div>
        
        <div class="column-mapping">
          <label>Service Name Column:</label>
          <input type="text" id="col-Service-Name" value="Service Name" placeholder="Enter column name">
        </div>
        
        <div class="column-mapping">
          <label>Sender Account Type Column:</label>
          <input type="text" id="col-Sender-Account-Type" value="Sender Account Type" placeholder="Enter column name">
        </div>
        
        <div class="column-mapping">
          <label>Sender Account Column:</label>
          <input type="text" id="col-Sender-Account" value="Sender Account" placeholder="Enter column name">
        </div>
        
        <div class="column-mapping">
          <label>Sender Account Currency Column:</label>
          <input type="text" id="col-Sender-Account-Currency" value="Sender Account Currency" placeholder="Enter column name">
        </div>
        
        <div class="column-mapping">
          <label>Receiver Account Type Column:</label>
          <input type="text" id="col-Receiver-Account-Type" value="Receiver Account Type" placeholder="Enter column name">
        </div>
        
        <div class="column-mapping">
          <label>Receiver Account Column:</label>
          <input type="text" id="col-Receiver-Account" value="Receiver Account" placeholder="Enter column name">
        </div>
        
        <div class="column-mapping">
          <label>Receiver Account Currency Column:</label>
          <input type="text" id="col-Receiver-Account-Currency" value="Receiver Account Currency" placeholder="Enter column name">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="resetColumnSettings()">Reset to Default</button>
        <button class="export-btn" onclick="saveColumnSettings()">Save & Apply</button>
      </div>
    </div>
  </div>

  <!-- Converter Modal -->
  <div id="converterModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Convert UserAccount Excel to JSON</h3>
        <button class="close-btn" onclick="closeConverterModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Select your UserAccount Excel file to convert it to JSON format. The JSON file will be automatically downloaded.</p>
        <div class="file-input-wrapper" style="width: 100%;">
          <input type="file" id="convertInput" accept=".xlsx,.xls">
          <label for="convertInput" class="file-input-label" style="width: 100%; text-align: center;">Select UserAccount Excel File</label>
        </div>
        <div id="convertStatus" style="margin-top: 15px; color: var(--text-secondary);"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeConverterModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
      
      const icon = document.getElementById('theme-icon');
      const text = document.getElementById('theme-text');
      if (newTheme === 'dark') {
        icon.textContent = '○';
        text.textContent = 'Light Mode';
      } else {
        icon.textContent = '●';
        text.textContent = 'Dark Mode';
      }
      
      localStorage.setItem('theme', newTheme);
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    if (savedTheme === 'dark') {
      document.getElementById('theme-icon').textContent = '○';
      document.getElementById('theme-text').textContent = 'Light Mode';
    }

    // Load user accounts once
    let userAccounts = [];
    
    // Handle JSON file selection
    document.getElementById('jsonInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          userAccounts = JSON.parse(event.target.result);
          console.log('User accounts loaded:', userAccounts.length);
          // If Excel file is already loaded, refresh the display
          if (window._groups) {
            refreshAllServices();
          }
        } catch (err) {
          console.error('Failed to parse JSON file', err);
          alert('Invalid JSON file format');
        }
      };
      reader.readAsText(file);
    });

    // Try to load default UserAccount.json
    fetch('./UserAccount.json')
      .then(res => res.json())
      .then(data => {
        userAccounts = data;
        console.log('Default user accounts loaded:', userAccounts.length);
      })
      .catch(err => console.log('No default UserAccount.json found, please select a file'));

    // Column settings
    let columnNames = {
      'NO': 'NO',
      'Service Name': 'Service Name',
      'Sender Account Type': 'Sender Account Type',
      'Sender Account': 'Sender Account',
      'Sender Account Currency': 'Sender Account Currency',
      'Receiver Account Type': 'Receiver Account Type',
      'Receiver Account': 'Receiver Account',
      'Receiver Account Currency': 'Receiver Account Currency'
    };

    // Load saved column settings
    const savedColumnNames = localStorage.getItem('columnNames');
    if (savedColumnNames) {
      columnNames = JSON.parse(savedColumnNames);
      // Update input fields
      Object.keys(columnNames).forEach(key => {
        const input = document.getElementById(`col-${key.replace(/\s+/g, '-')}`);
        if (input) input.value = columnNames[key];
      });
    }

    function openSettingsModal() {
      document.getElementById('settingsModal').classList.add('show');
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    function resetColumnSettings() {
      const defaults = {
        'NO': 'NO',
        'Service Name': 'Service Name',
        'Sender Account Type': 'Sender Account Type',
        'Sender Account': 'Sender Account',
        'Sender Account Currency': 'Sender Account Currency',
        'Receiver Account Type': 'Receiver Account Type',
        'Receiver Account': 'Receiver Account',
        'Receiver Account Currency': 'Receiver Account Currency'
      };
      
      Object.keys(defaults).forEach(key => {
        const input = document.getElementById(`col-${key.replace(/\s+/g, '-')}`);
        if (input) input.value = defaults[key];
      });
    }

    function saveColumnSettings() {
      const newSettings = {};
      Object.keys(columnNames).forEach(key => {
        const input = document.getElementById(`col-${key.replace(/\s+/g, '-')}`);
        if (input) newSettings[key] = input.value.trim() || key;
      });
      
      columnNames = newSettings;
      localStorage.setItem('columnNames', JSON.stringify(columnNames));
      
      // Re-read Excel if file is loaded
      const fileInput = document.getElementById('fileInput');
      if (fileInput.files[0]) {
        readExcel(fileInput.files[0], '1-WingBank_Current-Prod_Build');
      }
      
      closeSettingsModal();
      alert('Column settings saved and applied!');
    }

    function readExcel(file, sheetName) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[sheetName];
        if (!sheet) {
          document.getElementById('output').innerHTML = 'Sheet not found';
          return;
        }
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

        // fill merged cells
        (sheet['!merges'] || []).forEach(m => {
          const val = jsonData[m.s.r][m.s.c];
          for (let R = m.s.r; R <= m.e.r; ++R) {
            for (let C = m.s.c; C <= m.e.c; ++C) {
              jsonData[R][C] = val;
            }
          }
        });

        // Get header row number from input (convert to 0-based index)
        const headerRowNumber = parseInt(document.getElementById('headerRowInput').value) || 4;
        const headerRowIndex = headerRowNumber - 1;

        if (jsonData.length <= headerRowIndex) {
          document.getElementById('output').innerHTML = `Header row ${headerRowNumber} not found. File has only ${jsonData.length} rows.`;
          return;
        }
        
        // Use configured column names
        const columns = [
          'NO',
          'Service Name',
          'Sender Account Type',
          'Sender Account',
          'Sender Account Currency',
          'Receiver Account Type',
          'Receiver Account',
          'Receiver Account Currency'
        ];
        
        const headerRow = jsonData[headerRowIndex];
        // build a map: column name → index using configured names
        const colMap = {};
        columns.forEach(col => {
          const configuredName = columnNames[col];
          const i = headerRow.indexOf(configuredName);
          if (i !== -1) colMap[col] = i;
        });
        
        // expose header mapping
        window._colMap = colMap;

        if (Object.keys(colMap).length === 0) {
          document.getElementById('output').innerHTML = 'No specified columns found. Please check column settings.';
          return;
        }
        // group rows by service (start from row after header)
        const groups = {};
        for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          const svc = row[colMap['Service Name']] || 'Unknown';
          if (!groups[svc]) groups[svc] = [];
          groups[svc].push(row);
        }
        // expose groups
        window._groups = groups;

        // build containers with dropdown + empty table for each service
        let html = '';
        Object.keys(groups).forEach(service => {
          html += `<div class="service-container" data-service="${service}">`;
          html += `<h2>${service}</h2>`;
          html += `<div class="service-controls">`;
          html += `<label>Phone Number: <select id="phone-${service}"></select></label>`;
          html += `<button class="export-btn" onclick="exportService('${service}')">Export to Excel</button>`;
          html += `</div>`;
          html += `<table id="table-${service}"></table>`;
          html += `</div>`;
        });
        document.getElementById('output').innerHTML = html;

        // prepare phone‐number list and bind update handlers
        const phoneNumbers = [...new Set(userAccounts.map(a => a['Phone Number']))];
        Object.keys(groups).forEach(service => {
          const select = document.getElementById(`phone-${service}`);
          select.innerHTML = ''; // Clear existing options
          phoneNumbers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.text = p;
            select.add(opt);
          });
          select.addEventListener('change', () => updateService(service));
          updateService(service);  // initial draw
        });

        // redraw the table rows for one service + phone
        function updateService(service) {
          const phone = document.getElementById(`phone-${service}`).value;
          const rows = groups[service];
          const table = document.getElementById(`table-${service}`);
          // header
          let out = '<tr>';
          columns.forEach(c => {
            if (colMap[c] != null) {
              out += `<th>${c}</th>`;
            }
          });
          out += '</tr>';
          // rows
          rows.forEach(row => {
            const sType = row[colMap['Sender Account Type']] || '';
            const sCur  = row[colMap['Sender Account Currency']] || '';
            const rType = row[colMap['Receiver Account Type']] || '';
            const rCur  = row[colMap['Receiver Account Currency']] || '';
            const sAcc = (userAccounts.find(a => 
              a['Account Type']===sType && a['Currency']===sCur && a['Phone Number']===phone
            ) || {})['Account Number'] || '';
            const rAcc = (userAccounts.find(a => 
              a['Account Type']===rType && a['Currency']===rCur && a['Phone Number']===phone
            ) || {})['Account Number'] || '';
            out += '<tr>';
            columns.forEach(c => {
              let val = '';
              let cls = 'other-column';
              if (c === 'Sender Account') {
                val = sAcc;
                cls = 'sender-account';
              } else if (c === 'Receiver Account') {
                val = rAcc;
                cls = 'receiver-account';
              } else {
                val = row[colMap[c]] || '';
              }
              out += `<td class="${cls}">${val}</td>`;
            });
            out += '</tr>';
          });
          table.innerHTML = out;
        }

      };
      reader.readAsArrayBuffer(file);
    }

    // Refresh all service tables when user accounts change
    function refreshAllServices() {
      if (!window._groups) return;
      
      Object.keys(window._groups).forEach(service => {
        const select = document.getElementById(`phone-${service}`);
        if (select) {
          // Update phone number options
          const phoneNumbers = [...new Set(userAccounts.map(a => a['Phone Number']))];
          const currentValue = select.value;
          select.innerHTML = '';
          phoneNumbers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.text = p;
            select.add(opt);
          });
          // Restore previous selection if available
          if (phoneNumbers.includes(currentValue)) {
            select.value = currentValue;
          }
          // Refresh the table
          updateServiceById(service);
        }
      });
    }

    // Helper function to update service by ID
    function updateServiceById(service) {
      const phone = document.getElementById(`phone-${service}`).value;
      const rows = window._groups[service];
      const table = document.getElementById(`table-${service}`);
      const colMap = window._colMap;
      const columns = [
        'NO',
        'Service Name',
        'Sender Account Type',
        'Sender Account',
        'Sender Account Currency',
        'Receiver Account Type',
        'Receiver Account',
        'Receiver Account Currency'
      ];
      
      // header
      let out = '<tr>';
      columns.forEach(c => {
        if (colMap[c] != null) {
          out += `<th>${c}</th>`;
        }
      });
      out += '</tr>';
      // rows
      rows.forEach(row => {
        const sType = row[colMap['Sender Account Type']] || '';
        const sCur  = row[colMap['Sender Account Currency']] || '';
        const rType = row[colMap['Receiver Account Type']] || '';
        const rCur  = row[colMap['Receiver Account Currency']] || '';
        const sAcc = (userAccounts.find(a => 
          a['Account Type']===sType && a['Currency']===sCur && a['Phone Number']===phone
        ) || {})['Account Number'] || '';
        const rAcc = (userAccounts.find(a => 
          a['Account Type']===rType && a['Currency']===rCur && a['Phone Number']===phone
        ) || {})['Account Number'] || '';
        out += '<tr>';
        columns.forEach(c => {
          let val = '';
          let cls = 'other-column';
          if (c === 'Sender Account') {
            val = sAcc;
            cls = 'sender-account';
          } else if (c === 'Receiver Account') {
            val = rAcc;
            cls = 'receiver-account';
          } else {
            val = row[colMap[c]] || '';
          }
          out += `<td class="${cls}">${val}</td>`;
        });
        out += '</tr>';
      });
      table.innerHTML = out;
    }

    // Export function for a specific service
    function exportService(service) {
      const phone = document.getElementById(`phone-${service}`).value;
      const rows = window._groups[service];
      const colMap = window._colMap;
      const columns = [
        'NO',
        'Service Name',
        'Sender Account Type',
        'Sender Account',
        'Sender Account Currency',
        'Receiver Account Type',
        'Receiver Account',
        'Receiver Account Currency'
      ];

      // Build data array
      const exportData = [];
      // Header row
      const header = columns.filter(c => colMap[c] != null);
      exportData.push(header);

      // Data rows
      rows.forEach(row => {
        const sType = row[colMap['Sender Account Type']] || '';
        const sCur  = row[colMap['Sender Account Currency']] || '';
        const rType = row[colMap['Receiver Account Type']] || '';
        const rCur  = row[colMap['Receiver Account Currency']] || '';
        const sAcc = (userAccounts.find(a => 
          a['Account Type']===sType && a['Currency']===sCur && a['Phone Number']===phone
        ) || {})['Account Number'] || '';
        const rAcc = (userAccounts.find(a => 
          a['Account Type']===rType && a['Currency']===rCur && a['Phone Number']===phone
        ) || {})['Account Number'] || '';

        const dataRow = [];
        columns.forEach(c => {
          if (colMap[c] == null) return;
          let val = '';
          if (c === 'Sender Account') {
            val = sAcc;
          } else if (c === 'Receiver Account') {
            val = rAcc;
          } else {
            val = row[colMap[c]] || '';
          }
          dataRow.push(val);
        });
        exportData.push(dataRow);
      });

      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(exportData);

      // Set column widths
      const colWidths = [
        { wch: 10 },  // NO
        { wch: 20 },  // Service Name
        { wch: 20 },  // Sender Account Type
        { wch: 15 },  // Sender Account
        { wch: 12 },  // Sender Account Currency
        { wch: 20 },  // Receiver Account Type
        { wch: 15 },  // Receiver Account
        { wch: 12 }   // Receiver Account Currency
      ];
      ws['!cols'] = colWidths.slice(0, header.length);

      // Apply styling to cells
      const range = XLSX.utils.decode_range(ws['!ref']);
      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;

          // Initialize cell style
          ws[cellAddress].s = {
            border: {
              top: { style: 'thin', color: { rgb: 'DDDDDD' } },
              bottom: { style: 'thin', color: { rgb: 'DDDDDD' } },
              left: { style: 'thin', color: { rgb: 'DDDDDD' } },
              right: { style: 'thin', color: { rgb: 'DDDDDD' } }
            },
            alignment: { vertical: 'center', horizontal: 'left' }
          };

          // Header row styling
          if (R === 0) {
            ws[cellAddress].s.fill = { fgColor: { rgb: 'F2F2F2' } };
            ws[cellAddress].s.font = { bold: true };
            ws[cellAddress].s.alignment.horizontal = 'center';
          }

          // Color coding for account columns
          const colName = header[C];
          if (R > 0) {
            if (colName === 'Sender Account') {
              ws[cellAddress].s.font = { color: { rgb: '1E90FF' } };
            } else if (colName === 'Receiver Account') {
              ws[cellAddress].s.font = { color: { rgb: '32CD32' } };
            }
          }
        }
      }

      // Append sheet and export
      XLSX.utils.book_append_sheet(wb, ws, service.substring(0, 31));
      XLSX.writeFile(wb, `${service}_${phone}.xlsx`);
    }

    document.getElementById('fileInput').addEventListener('change', (e) => {
      readExcel(e.target.files[0], '1-WingBank_Current-Prod_Build');
    });

    // Re-read Excel when header row changes
    document.getElementById('headerRowInput').addEventListener('change', () => {
      const fileInput = document.getElementById('fileInput');
      if (fileInput.files[0]) {
        readExcel(fileInput.files[0], '1-WingBank_Current-Prod_Build');
      }
    });

    // Modal functions
    function openConverterModal() {
      document.getElementById('converterModal').classList.add('show');
    }

    function closeConverterModal() {
      document.getElementById('converterModal').classList.remove('show');
      document.getElementById('convertInput').value = '';
      document.getElementById('convertStatus').textContent = '';
    }

    // Convert UserAccount Excel to JSON
    document.getElementById('convertInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const status = document.getElementById('convertStatus');
      status.textContent = 'Converting...';
      status.style.color = 'var(--btn-secondary)';

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // Get first sheet
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          
          // Convert to JSON
          const records = XLSX.utils.sheet_to_json(sheet, { defval: null });
          
          // Create and download JSON file
          const jsonStr = JSON.stringify(records, null, 4);
          const blob = new Blob([jsonStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'UserAccount.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          status.textContent = `✓ Converted successfully! ${records.length} records exported.`;
          status.style.color = 'var(--btn-primary)';
          
          // Auto-load the converted data
          userAccounts = records;
          console.log('User accounts auto-loaded:', userAccounts.length);
          if (window._groups) {
            refreshAllServices();
          }

          // Auto-close modal after 2 seconds
          setTimeout(() => {
            closeConverterModal();
          }, 2000);

        } catch (err) {
          console.error('Conversion failed', err);
          status.textContent = '✗ Conversion failed: ' + err.message;
          status.style.color = '#f5576c';
        }
      };
      reader.readAsArrayBuffer(file);
    });

    // Close modal when clicking outside
    document.getElementById('converterModal').addEventListener('click', (e) => {
      if (e.target.id === 'converterModal') {
        closeConverterModal();
      }
    });

    // Close modal when clicking outside
    document.getElementById('settingsModal').addEventListener('click', (e) => {
      if (e.target.id === 'settingsModal') {
        closeSettingsModal();
      }
    });

  </script>
</body>
</html>